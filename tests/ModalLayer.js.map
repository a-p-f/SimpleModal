{"version":3,"file":"ModalLayer.js","sources":["../src/lockScroll.js","../src/iframe.js","../src/history_restore.js","../src/opening_page.js","../src/ModalLayer.js"],"sourcesContent":["let maxWidth, overflowX, overflowY;\nlet scrollTop, scrollLeft, isLocked;\nexport function lockScroll() {\n\tconst de = document.documentElement;\n\tconst ds = de.style;\n\tconst bs = document.body.style;\t\n\n\t// Save style values so we can restore\n\toverflowX = bs.overflowX;\n\toverflowY = bs.overflowY;\n\tmaxWidth = ds.maxWidth;\n\n\tscrollTop = de.scrollTop;\n\tscrollLeft = de.scrollLeft;\n\tisLocked = true;\n\n\t/*\n\t\tLock document dimensions.\n\t\tIn some browsers/configurations, toggling overflow will cause scrollbars to hide.\n\t\tLock dimensions so that the document doesn't reflow.\n\t*/\n\tds.maxWidth = de.clientWidth + 'px';\n\n\t// Now lock scrolling\n\tbs.overflowX = 'hidden';\n\tbs.overflowY = 'hidden';\n}\nexport function releaseScroll() {\n\tconst ds = document.documentElement.style;\n\tconst bs = document.body.style;\n\n\tisLocked = false;\n\n\tbs.overflowY = overflowY;\n\tbs.overflowX = overflowX;\n\n\tds.maxWidth = maxWidth;\n}\n/*\n\tNote - even though we've set overflow hidden on documentElement, that doesn't stop programmatic scrolling.\n\tIf the modal's initial content is positioned offscreen (ie. if it is going to animate into view), then some browsers (safari) may try to scroll the parent window's document to put the child window in view.\n\tSo we still need a scroll listener  to reset such browser-induced scrolling.\n*/\naddEventListener('scroll', function() {\n\tif (!isLocked) return\n\tdocument.documentElement.scrollTop = scrollTop;\n\tdocument.documentElement.scrollLeft = scrollLeft;\n})","import {lockScroll, releaseScroll} from './lockScroll.js';\n\nlet previousActiveElement;\nlet iframe = null;\n\nexport function create_iframe() {\n\t/*\n\t\tTODO:\n\t\tAdd mutation observer to detect when other scripts move/delete our iframe\n\t\t(log warning / throw exception when it does)\n\t\tThis breaks the page, because ModalLayer thinks child is open (and we block interaction of parent page). We could try to recover, but throwing exception is probably enough. External scripts should NOT be messing with our iframe while it is open.\n\t*/\n\n\tif (iframe) {\n\t\tthrow new Error('iframe already exists!');\n\t}\n\n\tlockScroll();\n\n\tpreviousActiveElement = getActiveElement();\n\taddEventListener('click', cancel, true);\n\tdocument.documentElement.addEventListener('focus', refocus_iframe, true);\n\n\tiframe = document.createElement('iframe');\n\tconst s = iframe.style;\n\t// TODO - fallback for browsers not supporting position: fixed (Opera Mini) ?\n\ts.position = 'fixed';\n\ts.top = 0;s.left = 0;s.width = '100%';s.height = '100%';\n\ts.border = 'none';\n\ts.margin = 0; s.padding = 0;\n\n\t// Don't make the iframe visible until it has loaded\n\t// This makes it easier to animate in\n\ts.visibility = 'hidden';\n\n\t// This is the maximum supported z-index in current browsers (max 32 bit signed int), but the CSS spec doesn't actually specify this\n\t// We need to set this value for IE, which doesn't work when you set z-index to any higher number\n\ts.zIndex = 2147483647;\n\n\t// This is MAX_SAFE_INTEGER in JS\n\t// This is larger than the maximum supported z-index in any current browser\n\t// In IE, this has no effect.\n\t// In other browsers, this always seems to set z-index to the highest supported value, and should protect against future increases in that value.\n\ts.zIndex = 9007199254740991;\n\n\tiframe.setAttribute('role', 'dialog');\n\t// TODO - test with screen reader in Safari, ensure content is accessible\n\t// See https://bugs.webkit.org/show_bug.cgi?id=174667\n\t// and https://developer.paciellogroup.com/blog/2018/06/the-current-state-of-modal-dialog-accessibility/\n\t// which suggest there is a serious issue in safari\n\tiframe.setAttribute('aria-modal', 'true');\n\tdocument.body.appendChild(iframe);\n\tiframe.focus();\n\n\treturn iframe;\n}\nexport function remove_iframe() {\n\tif (!iframe) return\n\tiframe.parentElement.removeChild(iframe);\n\tremoveEventListener('click', cancel, true);\n\tdocument.documentElement.removeEventListener('focus', refocus_iframe, true);\n\tpreviousActiveElement && previousActiveElement.focus();\n\tpreviousActiveElement = null;\n\tiframe = null;\n\treleaseScroll();\n}\nfunction cancel(event) {\n\tevent.stopPropagation();\n\tevent.preventDefault();\n}\n// TODO - play nice with other \"dynamic overlays\" - if focus moved to an element after iframe in DOM, then do nothing\nfunction refocus_iframe() {\n\tif (document.activeElement != iframe) iframe.focus();\n}\nfunction getActiveElement() {\n\tlet c = document.activeElement;\n\t// If the activeElement is an iframe, try to descend into the iframe\n\t// If we reach a cross-origin iframe, error will be thrown\n\ttry {\n\t\twhile (c && c.contentDocument && c.contentDocument.activeElement) {\n\t\t\tc = c.contentDocument.activeElement;\n\t\t}\n\t} catch(e) {}\n\treturn c;\n}","const DIRTY_NAME_PREFIX = 'ModalLayer-dirty-initial-history-position-';\nlet on_popstate = null;\n\nfunction safe_get_state() {\n    try {\n        return history.state;\n    }\n    catch (e) {\n        return null;\n    }\n}\nfunction get_initial_data_from_name() {\n    const matches = window.name.match(/^ModalLayer-dirty-initial-history-position-(\\d+):(.*)/);\n    return matches && {\n        position: parseInt(matches[1]),\n        name: matches[2],\n    }\n}\nfunction is_dirty() {\n    return Boolean(get_initial_data_from_name());\n}\nfunction return_to_initial_state_if_dirty() {\n    if (is_dirty()) {\n        return_to_initial_state(function() {});\n    }\n}\n\naddEventListener('popstate', function() {\n    if (on_popstate) {\n        on_popstate();\n        on_popstate = null;\n    }\n});\n\n// TODO - add tests to exercise these\naddEventListener('load', return_to_initial_state_if_dirty);\n// We shouldn't need to do this on BF cache - in that case, the modal SHOULD be open, and working properly\n// addEventListener('pageshow', return_to_initial_state_if_dirty);\n\nexport function mark_initial_state() {\n    // Eventually, we're going to return to this state via history.go()\n    // We need that transition to trigger a popstate event\n    // history.replaceState(safe_get_state(), '', location.href);\n\n    // Push another state, so that we know history.length is meaningful, and so we force a popstate event when returning to initial state\n    history.pushState(safe_get_state(), '', location.href);\n\n// }\n// export function record_previous_history_position() {\n    /*\n        Record previous history position on window.name\n\n        Should be called \"one state after\" you've called \"mark_initial_state\"\n\n        Need to record it somewhere such that the modal iframe can navigate around\n        (creating new history entries/states), and it will still be accessible if end-user reloads the page (or navigates away, and then comes back).\n\n        We don't want to mess with the url (in case end-user copies address while page is open),\n        so we can't store it there.\n\n        Note - we record history.length-1, because we want to return to the state BEFORE this one.\n    */\n    window.name = DIRTY_NAME_PREFIX + (history.length-1) + ':' + window.name;\n}\nexport function return_to_initial_state(then) {\n    if (!is_dirty()) {\n        throw new Error('Window is not dirty!');\n    }\n\n    const initial_data = get_initial_data_from_name();\n    window.name = initial_data.name;\n\n    // Push an extra state, so that history.length is meaningful\n    history.pushState(safe_get_state(), '', location.href);\n\n    // Call the callback AFTER we've returned to correct history state\n    const to_go_back = history.length - initial_data.position;\n    if (to_go_back) {\n        on_popstate = then;\n        history.go(-1 * to_go_back);\n    }\n    else {\n        then();\n    }\n}","let opening_page_url = null;\n\nexport function get_opening_page_url() {\n    if (!opening_page_url) {\n        throw new Error('You have not configured the \"opening page url\". Please refer to README.');\n    }\n    return opening_page_url;\n}\nexport function set_opening_page_url(url) {\n    // Use a link to resolve the url relative to current page\n    // We need an absolute url, so we can compare against iframe src later\n    const link = document.createElement('a');\n    link.href = url;\n    opening_page_url = link.href;\n}\n\n/*\n    Provide a means to specify opening page url in html.\n    User can set this attribute on any element which is present when script runs.\n    Recommend putting it directly on ModalLayer.js script.\n*/\nconst attr = 'modal-layer-opening-page-url';\nconst e = document.querySelector('['+attr+']');\nif (e) {\n    set_opening_page_url(e.getAttribute(attr));\n}","import {create_iframe, remove_iframe} from './iframe.js';\nimport * as history_restore from './history_restore.js';\nimport {get_opening_page_url} from './opening_page.js';\n\nexport {\n\tset_opening_page_url\n} from './opening_page.js'\n\nlet iframe;\nlet initial_url;\nlet onclose_callback;\nlet onclose_resolve;\nlet on_iframe_load_after_opening_page;\n\nfunction is_same_origin(iframe) {\n\treturn Boolean(iframe.contentDocument);\n}\nfunction should_set_opaque_background(iframe) {\n\t// If the iframe is x-origin, we cannot test the html element.\n\t// Have to assume the users have set it properly.\n\tif (!is_same_origin(iframe)) return false; \n\n\tconst color = getComputedStyle(iframe.contentDocument.documentElement).backgroundColor;\n\treturn color == 'transparent' || color == 'rgba(0, 0, 0, 0)';\n}\n\n/*\n\tListen to messages from child window\n*/\naddEventListener('message', function(event) {\n\tif (!iframe || event.source != iframe.contentWindow) return\n\t\n\t// User hit back button to return to opening page\n\tif (event.data == 'MODAL_LAYER_OPENING_PAGE_RETURNED') {\n\t\tcloseChild();\n\t\treturn\n\t}\n\n\t// x-origin child explicitly asked to be closed\n\tif (event.data && event.data.message == 'CLOSE_MODAL_LAYER_CHILD') {\n\t\tcloseChild(event.data.value);\n\t}\n\n\t// x-origin child told us it's title\n\tif (event.data && 'modal_layer_child_titled' in event.data) {\n\t\tiframe.setAttribute('aria-label', event.data.modal_layer_child_titled);\n\t}\n});\n// Listen to messages from parent\naddEventListener('message', function(event) {\n\tif (window.parent == window || event.source != window.parent) return\n\n\tif (event.data == 'MODAL_LAYER_CHILD_LOADED') {\n\t\tconst autofocus = document.querySelector('[autofocus]');\n\t\tautofocus && autofocus.focus();\n\t\twindow.parent.postMessage({\n\t\t\tmodal_layer_child_titled: document.title, \n\t\t}, '*');\n\t}\n});\n\nfunction make_absolute(url) {\n\tconst a = document.createElement('a');\n\ta.href = url;\n\treturn a.href;\n}\n\nexport function open(url, {\n\tonload=w=>{},\n\tonclose=value=>{},\n\n\t// Currently only used for testing (fake x-origin)\n\t// TODO - should we document? Users might want sandbox x-origin frames\n\tsandbox=null,\n}={}) {\n\tif (iframe) {\n\t\tthrow new Error('A ModalLayer is already open. A window may only open one ModalLayer at a time. We may relax this in the future, but for now, that\\'s the deal.');\n\t}\n\t// Will throw an error is user hasn't configured it yet.\n\t// Want to verify it's set before we proceed.\n\tconst opening_page_url = get_opening_page_url();\n\n\thistory_restore.mark_initial_state();\n\n\tiframe = create_iframe();\n\tonclose_callback = onclose;\n\tinitial_url = url;\n\tif (sandbox !== null) {\n\t\tiframe.setAttribute('sandbox', sandbox);\n\t}\n\n\tlet opening_page_loaded = false;\n\tiframe.onload = function() {\n\t\tif (!opening_page_loaded) {\n\t\t\topening_page_loaded = true;\n\n\t\t\t// Tell the iframe to advance\n\t\t\t// It will change its own location\n\t\t\t// In some browsers, this has different behaviour than changing iframe src\n\t\t\t// In Safari, changing iframe src will cause _this_ window to reload if the user hits the back button, which we can't have\n\t\t\tiframe.contentWindow.postMessage(make_absolute(url));\n\n\t\t\treturn\n\t\t}\n\n\t\t// Server-generated error pages won't have any background color.\n\t\t// It's really confusing when these load as a modal layer.\n\t\t// To help with that, if the background of the <html> element is totally transparent, we'll set a background color on the iframe\n\t\tiframe.style.backgroundColor = should_set_opaque_background(iframe) ? 'white' : '';\n\n\t\tif (is_same_origin(iframe)) {\n\t\t\tconst autofocus = iframe.contentDocument.querySelector('[autofocus]');\n\t\t\tautofocus && autofocus.focus();\n\t\t\tiframe.setAttribute('aria-label', iframe.contentDocument.title);\n\t\t}\n\t\telse {\n\t\t\t// Tell the child to autofocus and to pass us its title\n\t\t\tiframe.contentWindow.postMessage('MODAL_LAYER_CHILD_LOADED', '*');\n\t\t}\n\n\t\tonload(iframe.contentWindow);\n\n\t\tiframe.style.visibility = '';\n\t}\n\tiframe.src = opening_page_url;\n\n\t// Return a promise, but only if Promise() is implemented in browser\n\ttry {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tonclose_resolve = resolve;\n\t\t});\n\t} catch (e) {}\n}\n\nlet is_closing = false;\nexport function closeChild(value=null, then=null) {\n\tif (is_closing) {\n\t\tthrow new Error('ModalLayer is already in the process of closing a modal child.');\n\t}\n\tis_closing = true;\n\n\tremove_iframe();\n\n\tfunction done() {\n\t\tonclose_callback(value); \n\t\tonclose_resolve && onclose_resolve(value);\n\n\t\tis_closing = false;\n\t\tiframe = null;\n\t\tonclose_callback = null;\n\t\tonclose_resolve = null;\n\t\tthen && then(window);\n\t}\n\n\thistory_restore.return_to_initial_state(done);\n}\n\n// Note - needed by close() from child window, but we may or may not decide to document this function\nexport function getChild() {\n\treturn (iframe && iframe.contentWindow) || null;\n}\n\nfunction get_same_origin_parent_modal_layer() {\n\t// Throws an exception if parent is x-origin\n\t// Returns null if no parent or not a modal child (ie. regular iframe)\n\tconst pml = window.parent != window && window.parent.ModalLayer;\n\tif (!pml || pml.getChild() != window) return null;\n\treturn pml;\n}\nexport function close(value=null, then=null) {\n\tlet parent_modal_layer;\n\tlet x_origin = false;\n\ttry {\n\t\tparent_modal_layer = get_same_origin_parent_modal_layer();\n\t}\n\tcatch (e) {\n\t\tx_origin = true;\n\t}\n\n\tif (parent_modal_layer) {\n\t\t// Note - call parent's closeChild() directly, rather than using postMessage\n\t\t// This allows same-origin windows to pass non-serializable values\n\t\tparent_modal_layer.closeChild(value, then);\n\t\treturn\n\t}\n\tif (!x_origin) {\n\t\tthrow new Error('This window is not a ModalLayer child.');\n\t}\n\n\t/*\n\t\tParent is x-origin.\n\t\tCan't be sure we're a ModalLayer child.\n\t\tJust try to close.\n\t\tIf we're not a ModalLayer child, parent will (probably) just ignore this message, and nothing will happen.\n\t*/\n\tif (then) {\n\t\t/* \n\t\t\tFor same-origin, we can invoke the callback synchronously.\n\t\t\tFor x-origin, we tried using postMessage to have the child call the function, but that doesn't work.\n\t\t\tThe child window seems to get cleaned up as soon as we post the message.\n\t\t\t_perhaps_ we could support it if we stored a reference to the child window after we posted the message, but I don't think we should rely on a disconnected iframe receiving message events and running code.\n\n\t\t\tAlso, there isn't much useful that a cross-origin iframe could do in this state, anyway. The main purpose of \"then\" is to allow the (closed) child to navigate the parent.\n\t\t*/\n\t\tthrow new Error('\"then\" callback to ModalLayer.close is not supported in cross origin layers.');\n\t}\n\n\tparent.postMessage({\n\t\tvalue: value,\n\t\tmessage: 'CLOSE_MODAL_LAYER_CHILD',\n\t}, '*');\n}"],"names":["maxWidth","overflowX","overflowY","scrollTop","scrollLeft","isLocked","lockScroll","de","document","documentElement","ds","style","bs","body","clientWidth","releaseScroll","addEventListener","previousActiveElement","iframe","create_iframe","Error","getActiveElement","cancel","refocus_iframe","createElement","s","position","top","left","width","height","border","margin","padding","visibility","zIndex","setAttribute","appendChild","focus","remove_iframe","parentElement","removeChild","removeEventListener","event","stopPropagation","preventDefault","activeElement","c","contentDocument","e","DIRTY_NAME_PREFIX","on_popstate","safe_get_state","history","state","get_initial_data_from_name","matches","window","name","match","parseInt","is_dirty","Boolean","return_to_initial_state_if_dirty","return_to_initial_state","mark_initial_state","pushState","location","href","length","then","initial_data","to_go_back","go","opening_page_url","get_opening_page_url","set_opening_page_url","url","link","attr","querySelector","getAttribute","onclose_callback","onclose_resolve","is_same_origin","should_set_opaque_background","color","getComputedStyle","backgroundColor","source","contentWindow","data","closeChild","message","value","modal_layer_child_titled","parent","autofocus","postMessage","title","make_absolute","a","open","onload","w","onclose","sandbox","history_restore","opening_page_loaded","src","Promise","resolve","reject","is_closing","done","getChild","get_same_origin_parent_modal_layer","pml","ModalLayer","close","parent_modal_layer","x_origin"],"mappings":"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"}